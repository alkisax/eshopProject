tags:
  - name: Transactions
    description: Transaction management routes

paths:
  /api/transaction:
    get:
      summary: Get all transactions (admin only)
      tags: [Transactions]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: A list of transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)

    post:
      summary: Create a new transaction (internal / checkout flow)
      description: >
        Creates a transaction after a successful Stripe or IRIS checkout.
        This endpoint is used internally by the checkout flow.
      tags: [Transactions]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - participant
                - sessionId
              properties:
                participant:
                  type: string
                  format: objectId
                  example: "68ad7e285d9e6a24a76b249e"
                sessionId:
                  type: string
                  example: "cs_test_a1b2c3d4e5"
      responses:
        '201':
          description: Transaction created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Transaction'
        '400':
          description: Invalid input

  /api/transaction/unprocessed:
    get:
      summary: Get unprocessed transactions (admin only)
      tags: [Transactions]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of unprocessed transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)

  /api/transaction/iris:
    get:
      summary: Get all IRIS transactions (admin only)
      description: >
        Returns all transactions created via IRIS manual payment.
        IRIS transactions are identified by sessionId starting with `IRIS_`.
      tags: [Transactions]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of IRIS transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)

  /api/transaction/my:
    get:
      summary: Get my transactions (logged-in user)
      description: >
        Returns all transactions belonging to the currently authenticated user.
        The backend resolves the participant internally from the JWT user id.
        Returns an empty array if the user has no transactions yet.
      tags: [Transactions]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of user transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
        '401':
          description: Unauthorized

  /api/transaction/participant/{participantId}:
    get:
      summary: Get all transactions for a participant (admin only)
      description: >
        Returns all transactions for a specific participant.
        Admin access only.
      tags: [Transactions]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: participantId
          required: true
          schema:
            type: string
            format: objectId
          description: Participant ID
      responses:
        '200':
          description: List of participant transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
        '400':
          description: Missing participantId
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)
        '404':
          description: Participant not found

  /api/transaction/{id}:
    get:
      summary: Get transaction by ID (admin only)
      tags: [Transactions]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: objectId
      responses:
        '200':
          description: Transaction found
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Transaction'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)
        '404':
          description: Transaction not found

    delete:
      summary: Cancel a transaction (admin only)
      description: >
        Marks a transaction as cancelled.
        Transactions are not hard-deleted.
      tags: [Transactions]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transaction cancelled successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)
        '404':
          description: Transaction not found

  /api/transaction/toggle/{id}:
    put:
      summary: Toggle the processed status of a transaction (admin only)
      description: >
        Flips the `processed` flag for a transaction
        and triggers a thank-you email.
      tags: [Transactions]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transaction updated successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)
        '404':
          description: Transaction not found

  /api/transaction/clear/old:
    delete:
      summary: Delete old processed transactions (admin only)
      description: >
        Permanently deletes transactions marked as processed
        and older than 5 days.
      tags: [Transactions]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Old transactions deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    example: true
                  message:
                    type: string
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (admin only)
        '500':
          description: Server error
